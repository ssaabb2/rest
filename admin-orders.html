<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase: ضع مفاتيح مشروعك -->
<script>
  window.SUPABASE_URL  = "https://vlbcsujhgwbqsqcrtpny.supabase.co";   /* بدّلها */
  window.SUPABASE_ANON = "sb_publishable_iGmcWiB4iIvnQRYTfJ0n5A_bpR6jTmI";              
</script>

<!-- عميل Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
</script>

<!-- جسر Supabase الذي حمّلته -->
<script type="module" src="supabase-bridge.js"></script>

<!-- مزامنة الكتالوج للـlocalStorage قبل script.js -->
<script type="module">
  import { syncPublicCatalogToLocal } from './supabase-bridge.js';
  await syncPublicCatalogToLocal();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المطعم - إدارة الطلبات (KDS)</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* إضافات بسيطة للحالة "ملغي" وزر حذف أحمر */
    .dot-canceled{ background:#ef4444 }
    .kds-canceled{ opacity:.9; box-shadow:0 0 0 2px rgba(239,68,68,.22) inset }
    .btn-danger{ background:#ef4444; color:#fff }
    .btn-danger.btn-ghost{ background:transparent; color:#ef4444; border:1px solid rgba(239,68,68,.35) }

    /* قفل الأزرار أثناء التنفيذ */
    button[aria-busy="true"], .is-busy{
      pointer-events: none !important;
      opacity: .6 !important;
    }
  </style>

 <script type="module">
  import { requireAdminOrRedirect, syncAdminDataToLocal } from "./supabase-bridge.js";
  await requireAdminOrRedirect('login.html');    // يتحقق من الجلسة وعضويتك في admins
  await syncAdminDataToLocal();                  // يملأ localStorage من Supabase لتكمل سكربتاتك
</script>

</head>
<body>
  <nav class="navbar">
    <div class="container row">
      <div class="brand">لوحة تحكم المطعم</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">تسجيل الخروج</button>
        <a href="index.html" class="btn btn-ghost">عرض الموقع</a>
        <button id="refresh" class="btn btn-primary">تحديث</button>
        <div class="icon-btn" id="notifyBtn" title="الإشعارات">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <aside class="sidebar">
      <h3>المعلومات</h3>
      <a class="side-link" href="admin.html">لوحة المعلومات</a>
      <a class="side-link " href="admin-orders.html">إدارة الطلبات</a>
      <a class="side-link" href="admin-menu.html">إدارة المنيو</a>
      <a class="side-link" href="admin-cats.html">إدارة الأقسام</a>
      <a class="side-link" href="admin-ratings.html">إدارة التقييمات</a>
      <a class="side-link" href="admin-reports.html">التقارير</a>
      <a class="side-link" href="admin-reservations.html">معلومات الحجوزات</a>

      <div class="section">
        <div class="notice small">
          تصلك الإشعارات هنا بشكل فوري عند تنفيذ طلب جديد أو عند إضافة تقييم.
        </div>
      </div>
    </aside>

    <main class="main">
      <section id="orders" class="section card" style="padding:16px">
        <div class="kds-head">
          <div class="kds-tabs" id="kdsTabs">
            <button data-st="all" class="kds-tab active"><span class="dot dot-new"></span>الكل</button>
            <button data-st="new" class="kds-tab"><span class="dot dot-new"></span><span>جديد</span><span id="cnt-new" class="badge badge-muted small">0</span></button>
            <button data-st="received" class="kds-tab"><span class="dot dot-received"></span><span>قيد التحضير</span><span id="cnt-received" class="badge badge-muted small">0</span></button>
            <button data-st="preparing" class="kds-tab"><span class="dot dot-preparing"></span><span>جاهز</span><span id="cnt-preparing" class="badge badge-muted small">0</span></button>
            <button data-st="delivered" class="kds-tab"><span class="dot dot-delivered"></span><span>مُسلّم</span><span id="cnt-delivered" class="badge badge-muted small">0</span></button>
            <!-- جديد: تبويب الإلغائات -->
            <button data-st="canceled" class="kds-tab"><span class="dot dot-canceled"></span><span>الإلغائات</span><span id="cnt-canceled" class="badge badge-muted small">0</span></button>
          </div>
          <div class="kds-actions">
            <button id="demoOrder" class="btn btn-ghost">انشاء طلب  +</button>
            <button id="groupBtn" class="btn btn-ghost">تجميع الأصناف</button>
            <div class="kds-search">
              <input id="searchOrders" class="input" placeholder="بحث: رقم/اسم/طاولة/صنف" />
            </div>
          </div>
        </div>

        <div id="kdsGrid" class="kds-grid"></div>
      </section>

      <!-- hidden table to keep admin.js happy (no crash) -->
      <section style="display:none">
        <table class="table" id="ordersTable"><thead><tr><th></th></tr></thead><tbody></tbody></table>
      </section>
    </main>
  </div>

  <!-- Modal: group items -->
  <div id="groupModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:16px;background:#fff;color:#111">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">تجميع الأصناف (الطلبات النشطة)</h3>
        <button id="closeGroup" class="btn btn-ghost">إغلاق</button>
      </div>
      <div id="groupBody" class="small" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Notifications Drawer (reuse) -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>الإشعارات</strong>
      <button class="btn btn-ghost" id="closeNotif">إغلاق</button>
    </div>
    <div class="body"><div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div><div id="notifList"></div></div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">تمييز الكل كمقروء</button>
    </div>
  </aside>

  <script>
    /* ===== KDS logic ===== */

    // ✅ عربي مع أرقام لاتينية (إنكليزية)
    const LOCALE_LATN = 'ar-EG-u-nu-latn';
    const fmt = n => new Intl.NumberFormat(LOCALE_LATN).format(Number(n)||0);
    const dateFmt = iso => new Date(iso).toLocaleString(LOCALE_LATN);

    const LS = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
    const nowISO = () => new Date().toISOString();
    const itemsById = ()=>{ const arr=LS.get('menuItems',[]); const map={}; arr.forEach(i=>map[i.id]=i); return map; };
    const timeSince = (iso)=>{ const d=(Date.now()-new Date(iso).getTime())/1000|0; const m=(d/60)|0; const s=d%60; const mm = (m<10?'0':'')+m; const ss=(s<10?'0':'')+s; return mm+':'+ss };

    // ✨ دعم حالة "ملغي"
    const statusClass = s =>
      s==='new'?'kds-new':
      s==='received'?'kds-received':
      s==='preparing'?'kds-preparing':
      s==='canceled'?'kds-canceled':'kds-delivered';

    const meterColor = s =>
      s==='new'?'#f97316':
      s==='received'?'#3b82f6':
      s==='preparing'?'#10b981':
      s==='canceled'?'#ef4444':'#9ca3af';

    const nextAction = s => s==='new'?'بدء التحضير': s==='received'?'جاهز':'تسليم';
    const statusToNext = s => s==='new'?'received': s==='received'?'preparing':'delivered';

    const state = { tab: 'all', q: '' };

    function updateCounts(){
      const orders = LS.get('orders', []);
      const cNew = orders.filter(o=>o.status==='new').length;
      const cRec = orders.filter(o=>o.status==='received').length;
      const cPrep = orders.filter(o=>o.status==='preparing').length;
      const cDel = orders.filter(o=>o.status==='delivered').length;
      const cCan = orders.filter(o=>o.status==='canceled').length;
      document.getElementById('cnt-new').textContent = fmt(cNew);
      document.getElementById('cnt-received').textContent = fmt(cRec);
      document.getElementById('cnt-preparing').textContent = fmt(cPrep);
      document.getElementById('cnt-delivered').textContent = fmt(cDel);
      const cc = document.getElementById('cnt-canceled'); if(cc) cc.textContent = fmt(cCan);
    }

    function matchQuery(o, map){
      const q = state.q.trim();
      if(!q) return true;
      if(('#'+o.id).includes(q)) return true;
      if((o.orderName||'').includes(q)) return true;
      if((o.table||'').toString().includes(q)) return true;
      return o.items?.some(it => (map[it.itemId]?.name||'').includes(q));
    }

    function renderKDS(){
      const grid = document.getElementById('kdsGrid');
      const orders = LS.get('orders', []);
      const map = itemsById();
      updateCounts();

      const filtered = orders.filter(o => (state.tab==='all' ? true : o.status===state.tab))
                             .filter(o => matchQuery(o, map));

      if(filtered.length===0){
        grid.innerHTML = '<div class="small" style="color:var(--muted)">لا يوجد طلبات مطابقة.</div>';
        return;
      }

      grid.innerHTML = filtered.map(o=>{
        const prog = Math.min(100, (o.status==='new'?15: o.status==='received'?50: o.status==='preparing'?85:100));
        const statusCls = statusClass(o.status);
        const mc = meterColor(o.status);
        const title = (o.items?.[0]?.name || 'طلب');
        const itemLines = (o.items||[]).map(it=>{
          const nm = (map[it.itemId]?.name)||it.name||'عنصر';
          return `<div class="it"><div>${nm}</div><div class="kds-muted">× ${fmt(it.qty)}</div></div>`;
        }).join('');

        const addsSum = (o.additions && o.additions.length) ? o.additions.reduce((a,b)=>a+(Number(b.price)||0),0) : 0;
        const discPct = Number(o.discountPct||0);

        return `<div class="kds-card ${statusCls}" data-id="${o.id}">
          <div class="hdr">
            <div class="left">
              <div class="time" title="${dateFmt(o.time)}">${timeSince(o.time)}</div>
              <span class="chip">${o.table? 'طاولة ' + fmt(o.table) : 'سفري'}</span>
              ${o.source==='salla' ? '<span class="chip">سلة</span>' : ''}
              ${o.status==='delivered'?'<span class="chip">مُسلّم</span>': (o.status==='canceled'?'<span class="chip">ملغي</span>':'')}
            </div>
            <div class="kds-muted">#${fmt(o.id)}</div>
          </div>
          <div class="body">
            <div class="row">
              <div class="title">${o.orderName || title}</div>
              <div class="kds-muted">العناصر: ${fmt(o.itemCount ?? (o.items? o.items.reduce((a,b)=>a+(b.qty||0),0) : 0))}</div>
            </div>
            <div class="kds-items">${itemLines}</div>
            ${o.notes ? `<div style="margin-top:6px;color:var(--muted);font-size:.9rem">ملاحظات: ${o.notes}</div>` : ``}
            ${addsSum ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">إضافات: ${fmt(addsSum)} ر.س</div>` : ``}
            ${discPct ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">خصم: ${fmt(discPct)}%</div>` : ``}
          </div>
          <div class="kds-meter"><span style="width:${prog}%; background:${mc}"></span></div>
          <div class="kds-foot">
            <button class="btn btn-ghost" onclick="printOrder(${o.id})">طباعة</button>
            <button class="btn btn-ghost" onclick="cancelOrDelete(${o.id})">حذف/إلغاء</button>
            <button class="btn btn-ghost" onclick="editOrder(${o.id})">تعديل</button>
            <button class="btn btn-primary" onclick="advanceStatus(${o.id})">${nextAction(o.status)}</button>
          </div>
        </div>`;
      }).join('');
    }

    function notify(t, msg){
      const ns = LS.get('notifications', []);
      ns.unshift({id:crypto.randomUUID(), type:'order', title:t, message:msg||'', time:nowISO(), read:false});
      LS.set('notifications', ns);
      try{ updateNotifCount(); renderNotifs(); }catch(e){}
    }

async function setStatus(id, st){
  const orders = LS.get('orders', []);
  const o = orders.find(x=>x.id===id); if(!o) return;
  o.status = st;
  LS.set('orders', orders);
  renderKDS();
  updateCounts();
  try{ updateAll(); }catch(e){}

  try{
    if (window.supabaseBridge?.updateOrderSB) {
      await window.supabaseBridge.updateOrderSB(id, { status: st });
    }
  }catch(e){
    console.error(e);
    Modal.info('تم التحديث محلياً فقط. لم يُحدَّث في القاعدة.', 'تنبيه');
  }
}

    // Actions (محلية للحالات فقط)
    window.advanceStatus = function(id){
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(!o) return;
      const next = statusToNext(o.status);
      setStatus(id, next);
      notify(`تحديث حالة الطلب #${fmt(id)}`, next);
    }
    window.markReady = function(id){
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(!o) return;
      if(o.status==='received'){ setStatus(id, 'preparing'); notify(`الطلب جاهز #${fmt(id)}`, 'تم التجهيز'); }
    }
    window.markDelivered = function(id){
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(!o) return;
      setStatus(id, 'delivered'); notify(`تم تسليم الطلب #${fmt(id)}`, '');
    }

    /* ===== حذف/إلغاء ===== */
    async function deleteOrder(id){
      const btns = document.querySelectorAll(`.kds-card[data-id="${id}"] .kds-foot .btn`);
      btns.forEach(b=>{ b.disabled=true; b.setAttribute('aria-busy','true'); });
      try{
        if (window.supabaseBridge?.deleteOrderSB) {
          await window.supabaseBridge.deleteOrderSB(id);
        } else {
          let orders = LS.get('orders', []).filter(o => o.id !== id);
          LS.set('orders', orders);
        }
        renderKDS(); updateCounts(); try{ updateAll(); }catch(e){}
        notify(`تم حذف الطلب #${fmt(id)}`, '');
      }catch(e){
        console.error(e);
        Modal.info('تعذّر حذف الطلب من القاعدة. لم يتم الحذف.', 'خطأ');
      }finally{
        btns.forEach(b=>{ b.disabled=false; b.removeAttribute('aria-busy'); });
      }
    }

    window.cancelOrDelete = function(id){
      const yesCancel = document.createElement('button');
      yesCancel.className = 'btn btn-primary';
      yesCancel.textContent = 'إلغاء (تغيير الحالة)';
      yesCancel.onclick = ()=>{
        setStatus(id, 'canceled');
        notify(`تم إلغاء الطلب #${fmt(id)}`, '');
        Modal.hide();
      };

      const yesDelete = document.createElement('button');
      yesDelete.className = 'btn-danger btn-ghost';
      yesDelete.textContent = 'حذف نهائي';
      yesDelete.onclick = async ()=>{
        const ok = await Modal.confirm('سيتم حذف الطلب نهائياً. متابعة؟', 'تأكيد الحذف');
        if(ok){ deleteOrder(id); }
      };

      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-ghost';
      closeBtn.textContent = 'إغلاق';
      closeBtn.onclick = ()=> Modal.hide();

      Modal.show('حذف/إلغاء الطلب #' + fmt(id),
        `<div class="small">اختر الإجراء المطلوب:</div>`, [yesCancel, yesDelete, closeBtn]);
    };

    /* ===== تعديل الطلب (ملاحظات + إضافات + خصم) ===== */
    window.editOrder = function(id){
      /* ... نفس كود التعديل الذي أرسلته سابقاً بدون تغيير ... */
      // (اختصرت هنا تجنباً للإطالة — أبقيته كما هو في نسختك)
    };

    /* ===== طباعة الفاتورة ===== */
    window.printOrder = function(id){
      /* ... نفس كود الطباعة كما في نسختك ... */
    }

    // Tabs
    document.getElementById('kdsTabs').addEventListener('click', (e)=>{
      const btn = e.target.closest('.kds-tab'); if(!btn) return;
      document.querySelectorAll('.kds-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.tab = btn.getAttribute('data-st');
      renderKDS();
    });

    // Search
    document.getElementById('searchOrders').addEventListener('input', (e)=>{
      state.q = e.target.value;
      renderKDS();
    });

    // Group items modal
    const modal = document.getElementById('groupModal');
    document.getElementById('groupBtn').addEventListener('click', ()=>{
      const orders = LS.get('orders', []).filter(o=>o.status!=='delivered' && o.status!=='canceled');
      const map = itemsById();
      const agg = {};
      orders.forEach(o=> o.items?.forEach(it=>{
        const nm = (map[it.itemId]?.name)||it.name||'عنصر';
        agg[nm] = (agg[nm]||0) + (it.qty||0);
      }));
      const rows = Object.entries(agg).sort((a,b)=>b[1]-a[1]).map(([n,q])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee"><div>${n}</div><strong>× ${fmt(q)}</strong></div>`).join('') || '<div class="small" style="color:#666">لا يوجد طلبات نشطة</div>';
      document.getElementById('groupBody').innerHTML = rows;
      modal.classList.add('open');
    });
    document.getElementById('closeGroup').addEventListener('click', ()=> modal.classList.remove('open'));
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });

    // ======== سلة Sync ========
    function mergeOrdersFromSalla(list){
      const orders = LS.get('orders', []);
      const byId = new Map(orders.map(o=>[String(o.id), o]));
      (list||[]).forEach(o=>{
        const k = String(o.id);
        if(!byId.has(k)){ orders.unshift(o); byId.set(k, o); }
        else{
          const ref = byId.get(k);
          ref.status = o.status; ref.total = o.total; ref.items = o.items; ref.itemCount = o.itemCount; ref.time = o.time;
          ref.source = 'salla'; ref.external = o.external;
        }
      });
      LS.set('orders', orders);
      try{ updateAll(); }catch(e){}
      renderKDS();
    }
    async function fetchSalla(){
      try{
        const r = await fetch('/api/salla/orders');
        const data = await r.json();
        if(data && Array.isArray(data.orders)) mergeOrdersFromSalla(data.orders);
        else Modal.info('لم يتم العثور على طلبات من سلة','مزامنة سلة');
      }catch(e){
        Modal.info('تعذر مزامنة سلة','خطأ');
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const b = document.getElementById('syncSalla');
      if(b) b.addEventListener('click', fetchSalla);
    });

    // Live refresh each 10s for timers
    setInterval(()=>{ renderKDS(); }, 10000);

    // Init
    function init(){ try{ updateAll(); }catch(e){} renderKDS(); updateCounts(); }
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- Global App Modal (مرة واحدة فقط) -->
  <div id="appModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:0;background:#fff;color:#111;max-width:min(560px,95vw)">
      <div class="head" style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #eee">
        <strong id="appModalTitle">إشعار</strong>
        <button class="btn btn-ghost" id="appModalClose">إغلاق</button>
      </div>
      <div class="body" id="appModalBody" style="padding:14px;max-height:60vh;overflow:auto"></div>
      <div class="actions" id="appModalActions" style="display:flex;gap:8px;justify-content:flex-start;padding:12px 14px;border-top:1px solid #eee"></div>
    </div>
  </div>

  <!-- 👇 مهم: حمّل سكربت الإدارة العام (يُفَعّل درج الإشعارات والعداد) -->
  <script src="admin.js"></script>

  <!-- اختياري: حدّث العدّاد والقائمة عند مزامنة Supabase -->
  <script>
    document.addEventListener('sb:admin-synced', ()=>{
      try{ updateNotifCount(); updateOrderCounters(); updateReservationCounters(); renderNotifs(); }catch(e){}
    });
  </script>

  <!-- سكربت الصفحات المتعدّدة (يحتوي override لطريقة renderNotifs) -->
  <script src="admin-multipage.js"></script>
</body>
</html>
