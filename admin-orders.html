<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase: Ø¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ -->
<script>
  window.SUPABASE_URL  = "https://vlbcsujhgwbqsqcrtpny.supabase.co";   /* Ø¨Ø¯Ù‘Ù„Ù‡Ø§ */
  window.SUPABASE_ANON = "sb_publishable_iGmcWiB4iIvnQRYTfJ0n5A_bpR6jTmI";              
</script>

<!-- Ø¹Ù…ÙŠÙ„ Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
</script>

<!-- Ø¬Ø³Ø± Supabase Ø§Ù„Ø°ÙŠ Ø­Ù…Ù‘Ù„ØªÙ‡ -->
<script type="module" src="supabase-bridge.js"></script>

<!-- Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ Ù„Ù„Ù€localStorage Ù‚Ø¨Ù„ script.js -->
<script type="module">
  import { syncPublicCatalogToLocal } from './supabase-bridge.js';
  await syncPublicCatalogToLocal();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·Ø¹Ù… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (KDS)</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Ø¥Ø¶Ø§ÙØ§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø­Ø§Ù„Ø© "Ù…Ù„ØºÙŠ" ÙˆØ²Ø± Ø­Ø°Ù Ø£Ø­Ù…Ø± */
    .dot-canceled{ background:#ef4444 }
    .kds-canceled{ opacity:.9; box-shadow:0 0 0 2px rgba(239,68,68,.22) inset }
    .btn-danger{ background:#ef4444; color:#fff }
    .btn-danger.btn-ghost{ background:transparent; color:#ef4444; border:1px solid rgba(239,68,68,.35) }

    /* Ù‚ÙÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ° */
    button[aria-busy="true"], .is-busy{
      pointer-events: none !important;
      opacity: .6 !important;
    }
  </style>

 <script type="module">
  import { requireAdminOrRedirect, syncAdminDataToLocal } from "./supabase-bridge.js";
  await requireAdminOrRedirect('login.html');    // ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ¹Ø¶ÙˆÙŠØªÙƒ ÙÙŠ admins
  await syncAdminDataToLocal();                  // ÙŠÙ…Ù„Ø£ localStorage Ù…Ù† Supabase Ù„ØªÙƒÙ…Ù„ Ø³ÙƒØ±Ø¨ØªØ§ØªÙƒ
</script>

</head>
<body>
  <nav class="navbar">
    <div class="container row">
      <div class="brand">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·Ø¹Ù…</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <a href="index.html" class="btn btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
        <button id="refresh" class="btn btn-primary">ØªØ­Ø¯ÙŠØ«</button>
        <div class="icon-btn" id="notifyBtn" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <aside class="sidebar">
      <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
      <a class="side-link" href="admin.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</a>
      <a class="side-link " href="admin-orders.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="side-link" href="admin-menu.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ</a>
      <a class="side-link" href="admin-cats.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
      <a class="side-link" href="admin-ratings.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a>
      <a class="side-link" href="admin-reports.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
      <a class="side-link" href="admin-reservations.html">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</a>

      <div class="section">
        <div class="notice small">
          ØªØµÙ„Ùƒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ….
        </div>
      </div>
    </aside>

    <main class="main">
      <section id="orders" class="section card" style="padding:16px">
        <div class="kds-head">
          <div class="kds-tabs" id="kdsTabs">
            <button data-st="all" class="kds-tab active"><span class="dot dot-new"></span>Ø§Ù„ÙƒÙ„</button>
            <button data-st="new" class="kds-tab"><span class="dot dot-new"></span><span>Ø¬Ø¯ÙŠØ¯</span><span id="cnt-new" class="badge badge-muted small">0</span></button>
            <button data-st="received" class="kds-tab"><span class="dot dot-received"></span><span>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span><span id="cnt-received" class="badge badge-muted small">0</span></button>
            <button data-st="preparing" class="kds-tab"><span class="dot dot-preparing"></span><span>Ø¬Ø§Ù‡Ø²</span><span id="cnt-preparing" class="badge badge-muted small">0</span></button>
            <button data-st="delivered" class="kds-tab"><span class="dot dot-delivered"></span><span>Ù…ÙØ³Ù„Ù‘Ù…</span><span id="cnt-delivered" class="badge badge-muted small">0</span></button>
            <!-- Ø¬Ø¯ÙŠØ¯: ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¦Ø§Øª -->
            <button data-st="canceled" class="kds-tab"><span class="dot dot-canceled"></span><span>Ø§Ù„Ø¥Ù„ØºØ§Ø¦Ø§Øª</span><span id="cnt-canceled" class="badge badge-muted small">0</span></button>
          </div>
          <div class="kds-actions">
            <button id="demoOrder" class="btn btn-ghost">Ø§Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨  +</button>
            <button id="groupBtn" class="btn btn-ghost">ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
            <div class="kds-search">
              <input id="searchOrders" class="input" placeholder="Ø¨Ø­Ø«: Ø±Ù‚Ù…/Ø§Ø³Ù…/Ø·Ø§ÙˆÙ„Ø©/ØµÙ†Ù" />
            </div>
          </div>
        </div>

        <div id="kdsGrid" class="kds-grid"></div>
      </section>

      <!-- hidden table to keep admin.js happy (no crash) -->
      <section style="display:none">
        <table class="table" id="ordersTable"><thead><tr><th></th></tr></thead><tbody></tbody></table>
      </section>
    </main>
  </div>

  <!-- Modal: group items -->
  <div id="groupModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:16px;background:#fff;color:#111">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©)</h3>
        <button id="closeGroup" class="btn btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="groupBody" class="small" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- Notifications Drawer (reuse) -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</strong>
      <button class="btn btn-ghost" id="closeNotif">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="body"><div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div><div id="notifList"></div></div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>
    </div>
  </aside>

  <script>
    /* ===== KDS logic ===== */

    // âœ… Ø¹Ø±Ø¨ÙŠ Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ù„Ø§ØªÙŠÙ†ÙŠØ© (Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠØ©)
    const LOCALE_LATN = 'ar-EG-u-nu-latn';
    const fmt = n => new Intl.NumberFormat(LOCALE_LATN).format(Number(n)||0);
    const dateFmt = iso => new Date(iso).toLocaleString(LOCALE_LATN);

    const LS = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
    const nowISO = () => new Date().toISOString();
    const itemsById = ()=>{ const arr=LS.get('menuItems',[]); const map={}; arr.forEach(i=>map[i.id]=i); return map; };
    const timeSince = (iso)=>{ const d=(Date.now()-new Date(iso).getTime())/1000|0; const m=(d/60)|0; const s=d%60; const mm = (m<10?'0':'')+m; const ss=(s<10?'0':'')+s; return mm+':'+ss };

    // âœ¨ Ø¯Ø¹Ù… Ø­Ø§Ù„Ø© "Ù…Ù„ØºÙŠ"
    const statusClass = s =>
      s==='new'?'kds-new':
      s==='received'?'kds-received':
      s==='preparing'?'kds-preparing':
      s==='canceled'?'kds-canceled':'kds-delivered';

    const meterColor = s =>
      s==='new'?'#f97316':
      s==='received'?'#3b82f6':
      s==='preparing'?'#10b981':
      s==='canceled'?'#ef4444':'#9ca3af';

    const nextAction = s => s==='new'?'Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¶ÙŠØ±': s==='received'?'Ø¬Ø§Ù‡Ø²':'ØªØ³Ù„ÙŠÙ…';
    const statusToNext = s => s==='new'?'received': s==='received'?'preparing':'delivered';

    const state = { tab: 'all', q: '' };

    function updateCounts(){
      const orders = LS.get('orders', []);
      const cNew = orders.filter(o=>o.status==='new').length;
      const cRec = orders.filter(o=>o.status==='received').length;
      const cPrep = orders.filter(o=>o.status==='preparing').length;
      const cDel = orders.filter(o=>o.status==='delivered').length;
      const cCan = orders.filter(o=>o.status==='canceled').length;
      document.getElementById('cnt-new').textContent = fmt(cNew);
      document.getElementById('cnt-received').textContent = fmt(cRec);
      document.getElementById('cnt-preparing').textContent = fmt(cPrep);
      document.getElementById('cnt-delivered').textContent = fmt(cDel);
      const cc = document.getElementById('cnt-canceled'); if(cc) cc.textContent = fmt(cCan);
    }

    function matchQuery(o, map){
      const q = state.q.trim();
      if(!q) return true;
      if(('#'+o.id).includes(q)) return true;
      if((o.orderName||'').includes(q)) return true;
      if((o.table||'').toString().includes(q)) return true;
      return o.items?.some(it => (map[it.itemId]?.name||'').includes(q));
    }

    function renderKDS(){
      const grid = document.getElementById('kdsGrid');
      const orders = LS.get('orders', []);
      const map = itemsById();
      updateCounts();

      const filtered = orders.filter(o => (state.tab==='all' ? true : o.status===state.tab))
                             .filter(o => matchQuery(o, map));

      if(filtered.length===0){
        grid.innerHTML = '<div class="small" style="color:var(--muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
        return;
      }

      grid.innerHTML = filtered.map(o=>{
        const prog = Math.min(100, (o.status==='new'?15: o.status==='received'?50: o.status==='preparing'?85:100));
        const statusCls = statusClass(o.status);
        const mc = meterColor(o.status);
        const title = (o.items?.[0]?.name || 'Ø·Ù„Ø¨');
        const itemLines = (o.items||[]).map(it=>{
          const nm = (map[it.itemId]?.name)||it.name||'Ø¹Ù†ØµØ±';
          return `<div class="it"><div>${nm}</div><div class="kds-muted">Ã— ${fmt(it.qty)}</div></div>`;
        }).join('');

        const addsSum = (o.additions && o.additions.length) ? o.additions.reduce((a,b)=>a+(Number(b.price)||0),0) : 0;
        const discPct = Number(o.discountPct||0);

        return `<div class="kds-card ${statusCls}" data-id="${o.id}">
          <div class="hdr">
            <div class="left">
              <div class="time" title="${dateFmt(o.time)}">${timeSince(o.time)}</div>
              <span class="chip">${o.table? 'Ø·Ø§ÙˆÙ„Ø© ' + fmt(o.table) : 'Ø³ÙØ±ÙŠ'}</span>
              ${o.source==='salla' ? '<span class="chip">Ø³Ù„Ø©</span>' : ''}
              ${o.status==='delivered'?'<span class="chip">Ù…ÙØ³Ù„Ù‘Ù…</span>': (o.status==='canceled'?'<span class="chip">Ù…Ù„ØºÙŠ</span>':'')}
            </div>
            <div class="kds-muted">#${fmt(o.id)}</div>
          </div>
          <div class="body">
            <div class="row">
              <div class="title">${o.orderName || title}</div>
              <div class="kds-muted">Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${fmt(o.itemCount ?? (o.items? o.items.reduce((a,b)=>a+(b.qty||0),0) : 0))}</div>
            </div>
            <div class="kds-items">${itemLines}</div>
            ${o.notes ? `<div style="margin-top:6px;color:var(--muted);font-size:.9rem">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes}</div>` : ``}
            ${addsSum ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">Ø¥Ø¶Ø§ÙØ§Øª: ${fmt(addsSum)} Ø±.Ø³</div>` : ``}
            ${discPct ? `<div style="margin-top:4px;color:var(--muted);font-size:.9rem">Ø®ØµÙ…: ${fmt(discPct)}%</div>` : ``}
          </div>
          <div class="kds-meter"><span style="width:${prog}%; background:${mc}"></span></div>
          <div class="kds-foot">
            <button class="btn btn-ghost" onclick="printOrder(${o.id})">Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="btn btn-ghost" onclick="cancelOrDelete(${o.id})">Ø­Ø°Ù/Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-ghost" onclick="editOrder(${o.id})">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btn-primary" onclick="advanceStatus(${o.id})">${nextAction(o.status)}</button>
          </div>
        </div>`;
      }).join('');
    }

    function notify(t, msg){
      const ns = LS.get('notifications', []);
      ns.unshift({id:crypto.randomUUID(), type:'order', title:t, message:msg||'', time:nowISO(), read:false});
      LS.set('notifications', ns);
      try{ updateNotifCount(); renderNotifs(); }catch(e){}
    }

async function setStatus(id, st){
  const orders = LS.get('orders', []);
  const o = orders.find(x=>x.id===id); if(!o) return;
  o.status = st;
  LS.set('orders', orders);
  renderKDS();
  updateCounts();
  try{ updateAll(); }catch(e){}

  try{
    if (window.supabaseBridge?.updateOrderSB) {
      await window.supabaseBridge.updateOrderSB(id, { status: st });
    }
  }catch(e){
    console.error(e);
    Modal.info('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·. Ù„Ù… ÙŠÙØ­Ø¯Ù‘ÙØ« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©.', 'ØªÙ†Ø¨ÙŠÙ‡');
  }
}

    // Actions (Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø§Øª ÙÙ‚Ø·)
    window.advanceStatus = function(id){
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(!o) return;
      const next = statusToNext(o.status);
      setStatus(id, next);
      notify(`ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${fmt(id)}`, next);
    }
    window.markReady = function(id){
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(!o) return;
      if(o.status==='received'){ setStatus(id, 'preparing'); notify(`Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø§Ù‡Ø² #${fmt(id)}`, 'ØªÙ… Ø§Ù„ØªØ¬Ù‡ÙŠØ²'); }
    }
    window.markDelivered = function(id){
      const orders = LS.get('orders', []);
      const o = orders.find(x=>x.id===id); if(!o) return;
      setStatus(id, 'delivered'); notify(`ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ #${fmt(id)}`, '');
    }

    /* ===== Ø­Ø°Ù/Ø¥Ù„ØºØ§Ø¡ ===== */
    async function deleteOrder(id){
      const btns = document.querySelectorAll(`.kds-card[data-id="${id}"] .kds-foot .btn`);
      btns.forEach(b=>{ b.disabled=true; b.setAttribute('aria-busy','true'); });
      try{
        if (window.supabaseBridge?.deleteOrderSB) {
          await window.supabaseBridge.deleteOrderSB(id);
        } else {
          let orders = LS.get('orders', []).filter(o => o.id !== id);
          LS.set('orders', orders);
        }
        renderKDS(); updateCounts(); try{ updateAll(); }catch(e){}
        notify(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ #${fmt(id)}`, '');
      }catch(e){
        console.error(e);
        Modal.info('ØªØ¹Ø°Ù‘Ø± Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©. Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù.', 'Ø®Ø·Ø£');
      }finally{
        btns.forEach(b=>{ b.disabled=false; b.removeAttribute('aria-busy'); });
      }
    }

    window.cancelOrDelete = function(id){
      const yesCancel = document.createElement('button');
      yesCancel.className = 'btn btn-primary';
      yesCancel.textContent = 'Ø¥Ù„ØºØ§Ø¡ (ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©)';
      yesCancel.onclick = ()=>{
        setStatus(id, 'canceled');
        notify(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ #${fmt(id)}`, '');
        Modal.hide();
      };

      const yesDelete = document.createElement('button');
      yesDelete.className = 'btn-danger btn-ghost';
      yesDelete.textContent = 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ';
      yesDelete.onclick = async ()=>{
        const ok = await Modal.confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ', 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù');
        if(ok){ deleteOrder(id); }
      };

      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-ghost';
      closeBtn.textContent = 'Ø¥ØºÙ„Ø§Ù‚';
      closeBtn.onclick = ()=> Modal.hide();

      Modal.show('Ø­Ø°Ù/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ #' + fmt(id),
        `<div class="small">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</div>`, [yesCancel, yesDelete, closeBtn]);
    };

    /* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù„Ø§Ø­Ø¸Ø§Øª + Ø¥Ø¶Ø§ÙØ§Øª + Ø®ØµÙ…) ===== */
    window.editOrder = function(id){
      /* ... Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ... */
      // (Ø§Ø®ØªØµØ±Øª Ù‡Ù†Ø§ ØªØ¬Ù†Ø¨Ø§Ù‹ Ù„Ù„Ø¥Ø·Ø§Ù„Ø© â€” Ø£Ø¨Ù‚ÙŠØªÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ù†Ø³Ø®ØªÙƒ)
    };

    /* ===== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ===== */
    window.printOrder = function(id){
      /* ... Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ…Ø§ ÙÙŠ Ù†Ø³Ø®ØªÙƒ ... */
    }

    // Tabs
    document.getElementById('kdsTabs').addEventListener('click', (e)=>{
      const btn = e.target.closest('.kds-tab'); if(!btn) return;
      document.querySelectorAll('.kds-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.tab = btn.getAttribute('data-st');
      renderKDS();
    });

    // Search
    document.getElementById('searchOrders').addEventListener('input', (e)=>{
      state.q = e.target.value;
      renderKDS();
    });

    // Group items modal
    const modal = document.getElementById('groupModal');
    document.getElementById('groupBtn').addEventListener('click', ()=>{
      const orders = LS.get('orders', []).filter(o=>o.status!=='delivered' && o.status!=='canceled');
      const map = itemsById();
      const agg = {};
      orders.forEach(o=> o.items?.forEach(it=>{
        const nm = (map[it.itemId]?.name)||it.name||'Ø¹Ù†ØµØ±';
        agg[nm] = (agg[nm]||0) + (it.qty||0);
      }));
      const rows = Object.entries(agg).sort((a,b)=>b[1]-a[1]).map(([n,q])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee"><div>${n}</div><strong>Ã— ${fmt(q)}</strong></div>`).join('') || '<div class="small" style="color:#666">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</div>';
      document.getElementById('groupBody').innerHTML = rows;
      modal.classList.add('open');
    });
    document.getElementById('closeGroup').addEventListener('click', ()=> modal.classList.remove('open'));
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });

    // ======== Ø³Ù„Ø© Sync ========
    function mergeOrdersFromSalla(list){
      const orders = LS.get('orders', []);
      const byId = new Map(orders.map(o=>[String(o.id), o]));
      (list||[]).forEach(o=>{
        const k = String(o.id);
        if(!byId.has(k)){ orders.unshift(o); byId.set(k, o); }
        else{
          const ref = byId.get(k);
          ref.status = o.status; ref.total = o.total; ref.items = o.items; ref.itemCount = o.itemCount; ref.time = o.time;
          ref.source = 'salla'; ref.external = o.external;
        }
      });
      LS.set('orders', orders);
      try{ updateAll(); }catch(e){}
      renderKDS();
    }
    async function fetchSalla(){
      try{
        const r = await fetch('/api/salla/orders');
        const data = await r.json();
        if(data && Array.isArray(data.orders)) mergeOrdersFromSalla(data.orders);
        else Modal.info('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø³Ù„Ø©','Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø©');
      }catch(e){
        Modal.info('ØªØ¹Ø°Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø©','Ø®Ø·Ø£');
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const b = document.getElementById('syncSalla');
      if(b) b.addEventListener('click', fetchSalla);
    });

    // Live refresh each 10s for timers
    setInterval(()=>{ renderKDS(); }, 10000);

    // Init
    function init(){ try{ updateAll(); }catch(e){} renderKDS(); updateCounts(); }
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- Global App Modal (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
  <div id="appModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:0;background:#fff;color:#111;max-width:min(560px,95vw)">
      <div class="head" style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #eee">
        <strong id="appModalTitle">Ø¥Ø´Ø¹Ø§Ø±</strong>
        <button class="btn btn-ghost" id="appModalClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="body" id="appModalBody" style="padding:14px;max-height:60vh;overflow:auto"></div>
      <div class="actions" id="appModalActions" style="display:flex;gap:8px;justify-content:flex-start;padding:12px 14px;border-top:1px solid #eee"></div>
    </div>
  </div>

  <!-- ğŸ‘‡ Ù…Ù‡Ù…: Ø­Ù…Ù‘Ù„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù… (ÙŠÙÙÙØ¹Ù‘Ù„ Ø¯Ø±Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯) -->
  <script src="admin.js"></script>

  <!-- Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ù…Ø²Ø§Ù…Ù†Ø© Supabase -->
  <script>
    document.addEventListener('sb:admin-synced', ()=>{
      try{ updateNotifCount(); updateOrderCounters(); updateReservationCounters(); renderNotifs(); }catch(e){}
    });
  </script>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ù‘Ø¯Ø© (ÙŠØ­ØªÙˆÙŠ override Ù„Ø·Ø±ÙŠÙ‚Ø© renderNotifs) -->
  <script src="admin-multipage.js"></script>
</body>
</html>
