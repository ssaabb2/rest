<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- Supabase: ضع مفاتيح مشروعك -->
<script>
  window.SUPABASE_URL  = "https://vlbcsujhgwbqsqcrtpny.supabase.co";   /* بدّلها */
  window.SUPABASE_ANON = "sb_publishable_iGmcWiB4iIvnQRYTfJ0n5A_bpR6jTmI";               /* بدّلها */
</script>

<!-- عميل Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
</script>

<!-- جسر Supabase الذي حمّلته -->
<script type="module" src="supabase-bridge.js"></script>

<!-- مزامنة الكتالوج للـlocalStorage قبل script.js -->
<script type="module">
  import { syncPublicCatalogToLocal } from './supabase-bridge.js';
  await syncPublicCatalogToLocal();
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المطعم – إدارة التقييمات</title>
  <link rel="stylesheet" href="styles.css" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

 <script type="module">
  import { requireAdminOrRedirect, syncAdminDataToLocal } from "./supabase-bridge.js";
  await requireAdminOrRedirect('login.html');    // يتحقق من الجلسة وعضويتك في admins
  await syncAdminDataToLocal();                  // يملأ localStorage من Supabase لتكمل سكربتاتك
</script>

  <style>
    /* هذه الصفحة فقط */
    main > section{ display:none }
    main > section#ratings{ display:block }

    .rate-head{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px;
    }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .filters .input{ height:38px }
    .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;border:1px solid #eee;background:#fff;cursor:pointer;font-weight:800}
    .pill.active{background:var(--primary);color:#fff;border-color:transparent}
    .stats{ display:flex; gap:12px; flex-wrap:wrap }
    .stat-card{ background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:10px 12px; min-width:140px }
    .stat-card .val{ font-weight:900; font-size:1.15rem }

    .table-card{ border:1px solid #eef2f7; border-radius:16px; overflow:hidden; background:#fff; }
    .table-soft{ width:100%; border-collapse:separate; border-spacing:0; }
    .table-soft thead th{ background:#fff; color:#6b7280; font-weight:800; font-size:.95rem; padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:right }
    .table-soft tbody td{ padding:12px; border-bottom:1px solid #eef2f7; vertical-align:middle }
    .nowrap{ white-space:nowrap }
    .col-ops{ width:1%; white-space:nowrap }
    .ops-inline{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; overflow-x:auto; padding-bottom:2px }

    /* ——— تحسين تناسق الأزرار مع الموقع ——— */
    .btn-sm{ padding:6px 10px; font-size:.85rem; line-height:1.2 }
    .btn-pill{ border-radius:999px !important }
    /* زر حذف تحذيري خفيف متوافق مع درجات الموقع */
    .btn-danger{
      background:#fee2e2; border:1px solid #fecaca; color:#b91c1c;
    }
    .btn-danger:hover{ background:#fecaca }
    /* إذن تبقى .btn و .btn-ghost و .btn-primary كما في styles.css العامة */

    /* ذيل الجدول */
    .table-footer{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-top:1px solid #eef2f7; background:#fff;
    }
    .pager{ display:flex; align-items:center; gap:10px; }
    .pager .btn{ border-radius:999px; }
    .page-size{ display:flex; align-items:center; gap:6px; color:#6b7280; }
    .page-size select{ height:32px; border-radius:999px; border:1px solid #e5e7eb; padding:0 10px; background:#fff; }

    .stars-sm{ display:inline-flex; gap:4px; align-items:center }
    .stars-sm .s{ width:14px; height:14px; display:inline-block }
    .stars-sm .s::before{ content:'★'; display:block; line-height:1; font-size:14px; color:var(--star,#f59e0b) }
    .stars-sm .s.off::before{ color:#e5e7eb }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }

    @media (max-width:700px){
      .table-soft{ display:block; overflow-x:auto; white-space:nowrap }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container row">
      <div class="brand">لوحة تحكم المطعم</div>
      <div class="nav-actions">
        <button id="logoutBtn" class="btn btn-ghost">تسجيل الخروج</button>
        <a href="index.html" class="btn btn-ghost">عرض الموقع</a>
        <button id="refresh" class="btn btn-primary">تحديث</button>
        <div class="icon-btn" id="notifyBtn" title="الإشعارات">
          <span id="notifCount" class="icon-badge" style="display:none">0</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.4-1.4A2 2 0 0118 14.17V11a6 6 0 00-12 0v3.17a2 2 0 01-.6 1.43L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        </div>
      </div>
    </div>
  </nav>

  <div class="admin-layout">
    <aside class="sidebar">
      <h3>المعلومات</h3>
      <a class="side-link" href="admin.html">لوحة المعلومات</a>
      <a class="side-link" href="admin-orders.html">إدارة الطلبات</a>
      <a class="side-link" href="admin-menu.html">إدارة المنيو</a>
      <a class="side-link" href="admin-cats.html">إدارة الأقسام</a>
      <a class="side-link active" href="admin-ratings.html">إدارة التقييمات</a>
      <a class="side-link" href="admin-reports.html">التقارير</a>
      <a class="side-link" href="admin-reservations.html">معلومات الحجوزات</a>

      <div class="section">
        <div class="notice small">تصلك الإشعارات هنا بشكل فوري عند تنفيذ طلب جديد أو عند إضافة تقييم.</div>
      </div>
    </aside>

    <main class="main">
      <section id="ratings" class="section card" style="padding:16px">
        <div class="rate-head">
          <div class="filters">
            <input id="q" class="input" placeholder="بحث باسم الصنف…" />
            <div class="pill active" data-stars="all">الكل</div>
            <div class="pill" data-stars="5">5★</div>
            <div class="pill" data-stars="4">4★+</div>
            <div class="pill" data-stars="3">3★+</div>
            <div class="pill" data-stars="2">2★+</div>
            <div class="pill" data-stars="1">1★+</div>
          </div>
          <div class="filters">
            <button id="seedDemo" class="btn btn-ghost btn-sm btn-pill">عينات +</button>
            <button id="exportCsv" class="btn btn-ghost btn-sm btn-pill">تصدير CSV</button>
            <button id="clearAll" class="btn btn-ghost btn-sm btn-pill">حذف الكل</button>
          </div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="small" style="color:var(--muted)">عدد التقييمات</div>
            <div id="stCount" class="val">0</div>
          </div>
          <div class="stat-card">
            <div class="small" style="color:var(--muted)">متوسط عام</div>
            <div id="stAvg" class="val">0.0</div>
          </div>
        </div>

        <div class="table-card" style="margin-top:12px">
          <table id="rateTable" class="table-soft">
            <thead>
              <tr>
                <th class="mono">#</th>
                <th>الصنف</th>
                <th class="nowrap">التقييم</th>
                <th class="nowrap">التاريخ</th>
                <th class="col-ops">العمليات</th>
              </tr>
            </thead>
            <tbody id="rateBody"><tr><td class="small" colspan="5">—</td></tr></tbody>
          </table>
          <div class="table-footer">
            <div class="pager">
              <button id="prevPage" class="btn btn-ghost btn-sm btn-pill">السابق</button>
              <span id="pageInfo" class="mono">1 / 1</span>
              <button id="nextPage" class="btn btn-ghost btn-sm btn-pill">التالي</button>
            </div>
            <div class="page-size">
              <label>صفحة: </label>
              <select id="pageSize">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- درج الإشعارات -->
  <aside class="drawer" id="notifDrawer" aria-hidden="true" style="width:420px">
    <div class="head">
      <strong>الإشعارات</strong>
      <button class="btn btn-ghost" id="closeNotif">إغلاق</button>
    </div>
    <div class="body"><div id="notifSummary" class="small" style="margin-bottom:8px;color:var(--muted)"></div><div id="notifList"></div></div>
    <div class="totals">
      <button id="markAllRead" class="btn btn-primary">تمييز الكل كمقروء</button>
    </div>
  </aside>

  <!-- Modal عام للتعديل -->
  <div class="app-modal-overlay" id="appModal" aria-hidden="true">
    <div class="app-modal" role="dialog" aria-modal="true" aria-labelledby="appModalTitle">
      <header>
        <h3 id="appModalTitle">—</h3>
        <button id="appModalClose" class="btn btn-ghost">إغلاق</button>
      </header>
      <div class="body" id="appModalBody"></div>
      <footer class="actions" id="appModalActions"></footer>
    </div>
  </div>

  <script src="admin.js"></script>
  <script src="admin-multipage.js"></script>
  <script>
  (function(){
    /* ===== Helpers ===== */
    const LS = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)) };
    const LOCALE = 'ar-EG-u-nu-latn';
    const fmtNum = n => new Intl.NumberFormat(LOCALE).format(Number(n)||0);
    const toLocal = iso => { try{ return new Date(iso).toLocaleString(LOCALE) }catch(e){ return '-' } };

    const R = { q:'', stars:'all', page:1, size: Number(localStorage.getItem('rat_page_size')||10) };

    function listAll(){ return (LS.get('ratings',[])||[]).slice().sort((a,b)=> (b.time||'') .localeCompare(a.time||'')); }
    function itemsById(){ const map={}; (LS.get('menuItems',[])||[]).forEach(i=> map[i.id]=i); return map; }

    function starHtml(s){
      const n = Math.max(0, Math.min(5, Number(s)||0));
      let h = '<span class="stars-sm">';
      for(let i=1;i<=5;i++) h += `<span class="s ${i<=n?'':'off'}"></span>`;
      return h + '</span>';
    }

    function recalcItem(itemId){
      const items = LS.get('menuItems',[]);
      const it = items.find(x=>x.id===itemId);
      if(!it) return;
      const all = (LS.get('ratings',[])||[]).filter(r=> r.itemId===itemId);
      const count = all.length;
      const avg = count ? +(all.reduce((a,r)=> a + (Number(r.stars)||0), 0) / count).toFixed(2) : 0;
      it.rating = { avg, count };
      LS.set('menuItems', items);
    }

    function updateStats(list){
      const count = list.length;
      const avg = count ? (list.reduce((a,r)=>a + (Number(r.stars)||0),0) / count) : 0;
      document.getElementById('stCount').textContent = fmtNum(count);
      document.getElementById('stAvg').textContent = (avg||0).toFixed(2);
    }

    function render(){
      const q = (R.q||'').trim();
      const raw = listAll();
      const byId = itemsById();

      // فلترة
      let filtered = raw.filter(r=>{
        const name = r.name || byId[r.itemId]?.name || '';
        const okName = q==='' || name.includes(q);
        const s = Number(r.stars)||0;
        const okStars = (R.stars==='all') ? true :
                        (R.stars==='5'? s===5 :
                         R.stars==='4'? s>=4 :
                         R.stars==='3'? s>=3 :
                         R.stars==='2'? s>=2 : s>=1);
        return okName && okStars;
      });

      updateStats(filtered);

      // صفحات
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / R.size));
      if(R.page>pages) R.page=pages;
      if(R.page<1) R.page=1;
      const start = (R.page-1)*R.size;
      const pageRows = filtered.slice(start, start+R.size);

      // جسم الجدول
      const body = document.getElementById('rateBody');
      if(pageRows.length===0){
        body.innerHTML = '<tr><td colspan="5" class="small" style="color:var(--muted)">لا يوجد تقييمات مطابقة.</td></tr>';
      }else{
        body.innerHTML = pageRows.map((r,i)=>{
          const idx = start + i + 1;
          const safeId = JSON.stringify(r.id);
          const name = r.name || byId[r.itemId]?.name || '—';
          return `<tr>
            <td class="mono">${fmtNum(idx)}</td>
            <td>${name}</td>
            <td class="nowrap" title="${fmtNum(r.stars)}">${starHtml(r.stars)} <span class="small" style="margin-inline-start:6px">(${fmtNum(r.stars)})</span></td>
            <td class="nowrap">${toLocal(r.time)}</td>
            <td class="col-ops">
              <div class="ops-inline">
                <button class="btn btn-ghost btn-sm btn-pill" onclick='__rt.edit(${safeId})'>تعديل</button>
                <button class="btn btn-danger btn-sm btn-pill" onclick='__rt.remove(${safeId})'>حذف</button>
              </div>
            </td>
          </tr>`;
        }).join('');
      }

      document.getElementById('pageInfo').textContent = fmtNum(R.page) + ' / ' + fmtNum(pages);
      document.getElementById('prevPage').disabled = (R.page<=1);
      document.getElementById('nextPage').disabled = (R.page>=pages);
    }

    // عمليات عامة
    window.__rt = {
      async remove(id){
        const ok = await window.Modal.confirm('هل تريد حذف هذا التقييم؟','تأكيد الحذف');
        if(!ok) return;
        let list = listAll();
        const target = list.find(x=>x.id===id);
        list = list.filter(x=>x.id!==id);
        LS.set('ratings', list);
        if(target){ recalcItem(target.itemId); }
        try{ updateAll(); }catch(e){}
        render();
      },
      // === تم التعديل: اختيار الصنف + تعديل النجوم ===
      edit(id){
        const list = listAll();
        const r = list.find(x=>x.id===id); if(!r) return;

        const items = LS.get('menuItems',[]) || [];
        if(items.length === 0){
          window.Modal.info('لا توجد أصناف في المنيو لتغيير الارتباط.');
          return;
        }
        const byId = itemsById();
        const opts = items.map(it =>
          `<option value="${it.id}" ${it.id===r.itemId ? 'selected' : ''}>${it.name}</option>`
        ).join('');

        const html = `
          <div class="form">
            <label class="app-label">الصنف</label>
            <select id="edItem" class="input">${opts}</select>

            <label class="app-label">التقييم (1–5)</label>
            <input id="edStars" class="input" type="number" min="1" max="5" value="${Number(r.stars)||1}" />
          </div>
        `;
        const save = document.createElement('button'); save.className='btn btn-primary btn-pill'; save.textContent='حفظ';
        const cancel = document.createElement('button'); cancel.className='btn btn-ghost btn-pill'; cancel.textContent='إلغاء';

        save.onclick = ()=>{
          const sel = document.getElementById('edItem');
          const newItemId = sel ? sel.value : r.itemId;
          const v = Math.max(1, Math.min(5, Number(document.getElementById('edStars').value)||1));

          const oldItemId = r.itemId;
          r.stars = v;
          r.itemId = newItemId;
          r.name = byId[newItemId]?.name || r.name;

          LS.set('ratings', list);

          if(oldItemId !== newItemId){ recalcItem(oldItemId); }
          recalcItem(newItemId);

          window.Modal.hide();
          try{ updateAll(); }catch(e){}
          render();
        };
        cancel.onclick = ()=> window.Modal.hide();
        window.Modal.show('تعديل التقييم', html, [save, cancel]);
        setTimeout(()=> document.getElementById('edStars')?.focus(), 50);
      }
    };

    // تصدير CSV
    function exportCsv(){
      const rows = listAll();
      const byId = itemsById();
      const head = ['#','itemId','name','stars','time'];
      const lines = [head.join(',')];
      rows.forEach((r,i)=>{
        const name = (r.name || byId[r.itemId]?.name || '').replace(/"/g,'""');
        lines.push([i+1, r.itemId, `"${name}"`, r.stars, r.time||''].join(','));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ratings.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // عينات تجريبية
    function seedDemo(){
      const items = LS.get('menuItems',[])||[];
      if(items.length===0){ window.Modal.info('لا يوجد أصناف لإضافة تقييمات لها.'); return; }
      const rs = LS.get('ratings',[])||[];
      const now = Date.now();
      const pick = items.slice(0, Math.min(6, items.length));
      pick.forEach((it,idx)=>{
        const stars = (idx%5)+1;
        rs.unshift({ id: crypto.randomUUID(), itemId: it.id, stars, time: new Date(now - idx*3600e3).toISOString(), name: it.name });
      });
      LS.set('ratings', rs);
      pick.forEach(it=> recalcItem(it.id));
      try{ updateAll(); }catch(e){}
      render();
    }

    // أحداث الواجهة
    document.getElementById('q').addEventListener('input', (e)=>{ R.q = e.target.value; R.page = 1; render(); });
    document.querySelectorAll('.pill').forEach(p=>{
      p.addEventListener('click', ()=>{
        document.querySelectorAll('.pill').forEach(x=> x.classList.toggle('active', x===p));
        R.stars = p.dataset.stars || 'all';
        R.page = 1; render();
      });
    });
    document.getElementById('prevPage').onclick = ()=>{ R.page--; render(); };
    document.getElementById('nextPage').onclick = ()=>{ R.page++; render(); };
    const sizeSel = document.getElementById('pageSize');
    sizeSel.value = String(R.size);
    sizeSel.addEventListener('change', ()=>{ R.size = Number(sizeSel.value)||10; localStorage.setItem('rat_page_size', R.size); R.page=1; render(); });
    document.getElementById('exportCsv').onclick = exportCsv;
    document.getElementById('seedDemo').onclick = seedDemo;
    document.getElementById('clearAll').onclick = async ()=>{
      const ok = await window.Modal.confirm('سيتم حذف كل التقييمات وإعادة حساب المتوسطات. هل أنت متأكد؟','تحذير');
      if(!ok) return;
      LS.set('ratings', []);
      const items = LS.get('menuItems',[])||[];
      items.forEach(it=> it.rating = {avg:0,count:0});
      LS.set('menuItems', items);
      try{ updateAll(); }catch(e){}
      render();
    };

    // تحديث تلقائي إن تغيّر التخزين من تبويب آخر
    window.addEventListener('storage', (e)=>{ if(e.key==='ratings' || e.key==='menuItems'){ render(); } });

    // تشغيل أولي
    render();
  })();
  </script>
</body>
</html>
